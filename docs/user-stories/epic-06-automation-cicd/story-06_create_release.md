# Story 06: Create GitHub Release

**Story ID**: epic-06-story-06  
**Epic**: Epic 06 - Automation & CI/CD  
**Priority**: High  
**Estimate**: 2 hours  
**Status**: Not Started

## User Story

**As a** CI/CD workflow  
**I want** to create a GitHub release with the packaged archives  
**So that** users can download the archive from the releases page

## Acceptance Criteria

1. **Release Creation**
   - [ ] Create release with semantic version tag
   - [ ] Use release notes from statistics generation
   - [ ] Set release as latest
   - [ ] Include generated timestamp

2. **Tag Management**
   - [ ] Create annotated tag with version
   - [ ] Tag format: `vYYYY-MM.RUN_NUMBER`
   - [ ] Tags are chronologically sortable
   - [ ] Push tags to repository

3. **Release Metadata**
   - [ ] Clear release title with date
   - [ ] Comprehensive release notes from stats
   - [ ] Link to documentation
   - [ ] Include installation instructions

4. **Error Handling**
   - [ ] Handle duplicate tag/release
   - [ ] Retry on transient failures
   - [ ] Clean up on failure
   - [ ] Log release URL on success

## Technical Details

### Create Release Step

```yaml
- name: Create GitHub Release
  id: create-release
  uses: softprops/action-gh-release@v2
  with:
    tag_name: ${{ steps.version.outputs.release_version }}
    name: "iRO Wiki Archive - ${{ steps.version.outputs.release_date }}"
    body_path: release-notes.md
    draft: false
    prerelease: false
    generate_release_notes: false  # We provide our own
    make_latest: true
    files: |
      releases/*.tar.gz
      releases/*.tar.gz.*
      releases/*.sha256
      releases/README.md
      releases/RELEASE_INFO.json
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Log release information
  if: steps.create-release.outcome == 'success'
  run: |
    echo "✓ Release created successfully!"
    echo "Release URL: ${{ steps.create-release.outputs.url }}"
    echo "Release ID: ${{ steps.create-release.outputs.id }}"
    echo "Upload URL: ${{ steps.create-release.outputs.upload_url }}"
    
    # Save for notifications
    echo "release_url=${{ steps.create-release.outputs.url }}" >> $GITHUB_OUTPUT
```

### Alternative: Using GitHub CLI

```yaml
- name: Create release with gh CLI
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    VERSION="${{ steps.version.outputs.release_version }}"
    TITLE="iRO Wiki Archive - ${{ steps.version.outputs.release_date }}"
    
    # Check if release already exists
    if gh release view "$VERSION" &>/dev/null; then
      echo "Release $VERSION already exists, deleting..."
      gh release delete "$VERSION" -y
    fi
    
    # Create release
    gh release create "$VERSION" \
      --title "$TITLE" \
      --notes-file release-notes.md \
      --latest \
      releases/*.tar.gz \
      releases/*.tar.gz.* \
      releases/*.sha256 \
      releases/README.md \
      releases/RELEASE_INFO.json
    
    # Get release URL
    RELEASE_URL=$(gh release view "$VERSION" --json url --jq .url)
    echo "Release URL: $RELEASE_URL"
    echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
```

### Handle Duplicate Releases

```yaml
- name: Check for existing release
  id: check-release
  continue-on-error: true
  run: |
    VERSION="${{ steps.version.outputs.release_version }}"
    
    if gh release view "$VERSION" 2>/dev/null; then
      echo "exists=true" >> $GITHUB_OUTPUT
      echo "⚠ Release $VERSION already exists"
    else
      echo "exists=false" >> $GITHUB_OUTPUT
      echo "✓ Release $VERSION does not exist"
    fi
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Delete existing release if needed
  if: steps.check-release.outputs.exists == 'true'
  run: |
    VERSION="${{ steps.version.outputs.release_version }}"
    echo "Deleting existing release $VERSION..."
    gh release delete "$VERSION" -y
    git push --delete origin "$VERSION" || true
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### Release Notes Enhancement

```yaml
- name: Enhance release notes
  run: |
    # Add footer to release notes
    cat >> release-notes.md <<'EOF'

---

## Links

- [Repository](https://github.com/${{ github.repository }})
- [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
- [Go SDK Documentation](https://pkg.go.dev/github.com/${{ github.repository }}/sdk)
- [Report Issues](https://github.com/${{ github.repository }}/issues)

## Previous Releases

See [all releases](https://github.com/${{ github.repository }}/releases) for historical archives.

## Automation

This release was automatically generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) on ${{ steps.version.outputs.release_date }}.
EOF
```

### Retry Logic

```yaml
- name: Create release with retry
  uses: nick-fields/retry@v3
  with:
    timeout_minutes: 10
    max_attempts: 3
    retry_on: error
    command: |
      gh release create "${{ steps.version.outputs.release_version }}" \
        --title "iRO Wiki Archive - ${{ steps.version.outputs.release_date }}" \
        --notes-file release-notes.md \
        --latest \
        releases/*.tar.gz \
        releases/*.sha256
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## Dependencies

- **Story 04**: Generate statistics (creates release notes)
- **Story 05**: Package release (creates archives)

## Implementation Notes

- Use `softprops/action-gh-release` for simplicity
- GitHub CLI (`gh`) provides more control
- GITHUB_TOKEN is automatically provided
- Releases are public if repo is public
- Large files may take time to upload
- Consider upload timeout for large archives
- Glob patterns in `files:` work well

## Testing Requirements

- [ ] Test release creation with small files
- [ ] Test with large files (>1GB)
- [ ] Test duplicate release handling
- [ ] Test with split archives
- [ ] Verify release appears on releases page
- [ ] Test release notes formatting
- [ ] Verify all files uploaded
- [ ] Test release URL accessibility

## Definition of Done

- [ ] Release creation step implemented
- [ ] Tag management implemented
- [ ] Duplicate handling implemented
- [ ] Retry logic implemented
- [ ] Release notes enhancement implemented
- [ ] Error handling implemented
- [ ] Workflow logs release URL
- [ ] Tested with real data
- [ ] Documentation updated
- [ ] Code reviewed and approved
